#!/usr/bin/env python3
import codecs
from csv import DictReader
from decimal import Decimal
from io import BytesIO
from urllib.request import urlopen
from zipfile import ZipFile


# "FC_RECORD_ID","SOURCE","OUTPUT_FREQ","INPUT_FREQ","STATE","CITY","LOCALE",
# "CALL","SPONSOR","CTCSS_IN","CTCSS_OUT","DCS_CDCSS","DTMF","LINK",
# "FM_WIDE","FM_NARROW","DSTAR_DV","DSTAR_DD","DMR","DMR_COLOR_CODE",
# "FUSION","FUSION_DSQ","P25_PHASE_1","P25_PHASE_2","P25_NAC",
# "NXDN_DIGITAL","NXDN_MIXED","NXDN_RAN","ATV","DATV","RACES","ARES","WX",
# "URL","LATITUDE","LONGITUDE","EXPIRATION_DATE","COMMENT"

FORMAT = "{:6}{:10.4f}{:10.4f} {:+.2f}{}"

# Comments are taken from the WWARA Band Plan dated 12/18/21
# And WWARA 70cm Band Plan date November 2020
# Also https://www.wwara.org/WWARA_BAND_PLAN_2016_07_06.pdf
RULES = [
    # 10-Meter Band
    # * 20kHz channel spacing
    # 29.6200 - 29.6800 Repeater Outputs 20 kHz Spacing
    # * Paired with repeater inputs - 0.1MHz
    # 29.5200 - 29.5800 Repeater Inputs 20 kHz Spacing
    # * Paired with repeater outputs + 0.1MHz
    {
        "low": Decimal("29.62"),
        "high": Decimal("29.68"),
        "offset": Decimal("-0.1"),
        "spacing": Decimal("20"),
    },
    # 6-Meter Band
    # 52.8100 - 53.9900 FM Repeater Outputs
    # * Paired with repeater inputs -1.7MHz
    # 51.1000 - 52.2900 FM Repeater inputs
    # * Paired with repeater inputs +1.7MHz
    # (ajorg) s/inputs/outputs/
    # * 20kHz channel spacing
    # (ajorg) TODO
    # * 52.19/52.99 Shared Non-Protected (SNP) repeater pair
    {
        "low": Decimal("52.81"),
        "high": Decimal("53.99"),
        "offset": Decimal("-1.7"),
        "spacing": Decimal("20"),
    },
    # 2-Meter Band
    # 145.1000 - 145.2000 FM Repeater/Linear Translator outputs
    # 144.5000 - 144.6000 FM Repeater/Linear Translator inputs
    # * Washington, the adjoining States and BC use 20 kHz spacing
    #   between repeater channels
    # * Repeater channels are on odd frequencies below 146 MHz
    #   and even frequencies above 146 MHz
    # (ajorg) TODO
    # * 144.53/145.13 and 144.69/145.29 Shared Non-Protected
    #   (SNP) repeater pair
    # (ajorg) Based on coordinated pairs, center frequencies are
    #         145.1100 - 145.1900
    {
        "low": Decimal("145.11"),
        "high": Decimal("145.19"),
        "offset": Decimal("-0.6"),
        "spacing": Decimal("20"),
    },
    # 2-Meter Band
    # 145.2000 - 145.4900 FM Repeater outputs
    # (ajorg) 145.2100 - ?
    # 144.6000 - 144.9000 FM Repeater inputs
    # (ajorg)  - 144.8900 ?
    {
        "low": Decimal("145.21"),
        "high": Decimal("145.49"),
        "offset": Decimal("-0.6"),
        "spacing": Decimal("20"),
    },
    # 2-Meter Band
    # 146.0050 Special UNBD Repeater Output #1
    # 146.6050 Special UNBD Repeater Input #1
    # "We flipped the input & output due to interference issues at the site."
    # * Two Special UNBD channels, 6.25 kHz bandwidth only
    {
        "low": Decimal("146.605"),
        "high": Decimal("146.605"),
        "offset": Decimal("-0.6"),
        "spacing": Decimal("0"),
    },
    # 2-Meter Band
    # 147.9950 Special UNBD Repeater Output #2
    # 147.3950 Special UNBD Repeater Input #2
    # * Two Special UNBD channels, 6.25 kHz bandwidth only
    {
        "low": Decimal("147.995"),
        "high": Decimal("147.995"),
        "offset": Decimal("-0.6"),
        "spacing": Decimal("0"),
    },
    # 2-Meter Band
    # 146.40625 - 146.50625 VNBD Repeater Outputs
    # 147.40625 - 147.50625 VNBD Repeater Inputs
    # * 146.4125, bottom center frequency; 12.5 kHz steps, 8
    #   channels to 146.5000, + 1 MHz offset; VNBD, UNBD only
    {
        "low": Decimal("146.4125"),
        "high": Decimal("146.5"),
        "offset": Decimal("1"),
        "spacing": Decimal("12.5"),
    },
    # 2-Meter Band
    # 146.6200 - 147.3800 Repeater outputs
    # * Repeater channels are on odd frequencies below 146 MHz
    #   and even frequencies above 146 MHz
    # {
    #    "low": Decimal("146.62"),
    #    "high": Decimal("147.38"),
    #    "offset": Decimal(""), # Â±0.6
    #    "spacing": Decimal("20"),
    # },
    # 2-Meter Band
    # 146.0100 - 146.4000 Repeater inputs
    # (ajorg) 146.0200 - 146.4000 Repeater inputs (center frequencies)
    {
        "low": Decimal("146.62"),
        "high": Decimal("147"),
        "offset": Decimal("-0.6"),
        "spacing": Decimal("20"),
    },
    # 2-Meter Band
    # 147.6100 - 147.9900 Repeater inputs
    # (ajorg) 147.6000 - 147.98 Repeater inputs (center frequencies)
    {
        "low": Decimal("147.00"),
        "high": Decimal("147.38"),
        "offset": Decimal("0.6"),
        "spacing": Decimal("20"),
    },
    # 1.25m MHz Band Plan
    # 223.7800 - 223.9800 Repeater Outputs
    # 222.1800 - 222.3800 Repeater Inputs
    # * All FM Repeaters and simplex operations are on 20 kHz
    #   spacing
    {
        "low": Decimal("223.78"),
        "high": Decimal("223.98"),
        "offset": Decimal("-1.6"),
        "spacing": Decimal("20"),
    },
    # 1.25m MHz Band Plan
    # 224.0200 - 224.6200 Repeater Outputs
    # 222.4200 - 223.0200 Repeater Inputs
    {
        "low": Decimal("224.02"),
        "high": Decimal("224.62"),
        "offset": Decimal("-1.6"),
        "spacing": Decimal("20"),
    },
    # 1.25m MHz Band Plan
    # 224.6800 - 224.8200 Repeater Outputs
    # 223.0800 - 223.2200 Repeater Inputs
    {
        "low": Decimal("224.68"),
        "high": Decimal("224.82"),
        "offset": Decimal("-1.6"),
        "spacing": Decimal("20"),
    },
    # 1.25m MHz Band Plan
    # 224.8600 - 224.9800 Repeater Outputs
    # 223.2600 - 223.3800 Repeater Inputs
    {
        "low": Decimal("224.86"),
        "high": Decimal("224.98"),
        "offset": Decimal("-1.6"),
        "spacing": Decimal("20"),
    },
    # 70cm Band Plan
    # 440.0000 - 445.0000 Repeater outputs, links and simplex
    # 445.0000 - 450.0000 Repeater inputs, links and simplex
    # * NBFM channel spacing is 25 kHz, VNBD spacing is 12.5 kHz.
    # (ajorg) 440.0125 - 444.9875 N (VNBD) Rptr Outputs
    # (ajorg) 445.0125 - 449.9875 N (VNBD) Rptr Inputs
    {
        "low": Decimal("440.0125"),
        "high": Decimal("444.9875"),
        "offset": Decimal("5"),
        "spacing": Decimal("12.5"),
    },
    # (ajorg) 440.0500 - 444.9750 W (NB) Rptr Outputs
    # (ajorg) 445.0500 - 449.9750 W (NB) Rptr Inputs
    {
        "low": Decimal("440.05"),
        "high": Decimal("444.975"),
        "offset": Decimal("5"),
        "spacing": Decimal("25"),
    },
    # 70cm Band Plan
    # 440.0000 Shared Non-Protected Pair (SNP) #1 output
    # 445.0000 Shared Non-Protected Pair (SNP) #1 input
    # TODO SNPs
    # {
    #    "low": Decimal("440"),
    #    "high": Decimal("440"),
    #    "offset": Decimal("5"),
    #    "spacing": Decimal("0"),
    # },
    # 70cm Band Plan
    # 440.7000 - 440.7750 Narrowband digital repeater outputs
    # 445.7000 - 445.7750 Narrowband digital repeater inputs
    # * All channels spacing is VNBD or 12.5 kHz.
    # (ajorg) Last channel in this range is 440.7875
    {
        "low": Decimal("440.7"),
        "high": Decimal("440.7875"),
        "offset": Decimal("5"),
        "spacing": Decimal("12.5"),
    },
    # 70cm Band Plan
    # 443.0000 Shared Non-Protected Pair (SNP) #2 output
    # 448.0000 Shared Non-Protected Pair (SNP) #2 input
    # TODO SNPs
    # {
    #    "low": Decimal("443"),
    #    "high": Decimal("443"),
    #    "offset": Decimal("5"),
    #    "spacing": Decimal("0"),
    # },
    # 33cm MHz Band Plan
    # 927.3000 - 928.0000 Repeater Outputs
    # 902.3000 - 903.0000 Repeater inputs
    # * All FM and data channels at 25 kHz spacing
    {
        "low": Decimal("927.3"),
        "high": Decimal("928"),
        "offset": Decimal("-25"),
        "spacing": Decimal("25"),
    },
    # 23cm MHz Band Plan
    # 1247.000 - 1252.000 D-STAR DD mode repeaters
    # * All FM simplex and repeater channels are on 25kHz spacing
    # (ajorg) DD repeaters are simplex?
    {
        "low": Decimal("1247"),
        "high": Decimal("1252"),
        "offset": Decimal("0"),
        "spacing": Decimal("25"),
    },
    # 23cm MHz Band Plan
    # 1240.000 - 1246.000 ATV #1
    # 1252.000 - 1258.000 ATV #2
    # 421.2500 Video carrier for ATV
    # 427.2500 Video carrier for ATV
    # 434.0000 Video carrier for ATV
    # (ajorg) TODO ATV is complicated
    # 23cm MHz Band Plan
    # 1290.000 - 1291.000 D-STAR DV mode repeater outputs
    # 1270.000 - 1271.000 D-STAR DV mode repeater inputs
    # * Includes other narrowband modes with 25kHz spacing
    {
        "low": Decimal("1290"),
        "high": Decimal("1291"),
        "offset": Decimal("-20"),
        "spacing": Decimal("25"),
    },
    # 23cm MHz Band Plan
    # 1290.000 - 1295.000 Repeater Outputs
    # 1270.000 - 1275.000 Repeater Inputs
    # * All FM simplex and repeater channels are on 25kHz spacing
    {
        "low": Decimal("1290"),
        "high": Decimal("1295"),
        "offset": Decimal("-20"),
        "spacing": Decimal("25"),
    },
]

EXCEPTIONS = {
    # FIXME hack for ATV (cross-band)
    ("WW7ATS", Decimal("1253.25"), Decimal("434")): {"comment": "ATV"},
}
ERRORS = {
    # KC7IYE   53.0700   51.6700 -1.40 ERROR!
    ("KC7IYE", Decimal("53.07"), Decimal("51.67")): {
        "comment": "https://docs.google.com/spreadsheets/d/1g-Zu05g6w6tif-wiV_KG0GVv6gk4HttjxFIjC5MU39U/edit#gid=0&range=13:13"
    },
    # KG7MOY  147.0000  147.6000  0.60 ERROR!
    ("KG7MOY", Decimal("147"), Decimal("147.6")): {
        "comment": "https://docs.google.com/spreadsheets/d/1g-Zu05g6w6tif-wiV_KG0GVv6gk4HttjxFIjC5MU39U/edit#gid=0&range=3:3"
    },
    # WA6MPG  224.9800  222.3800 -2.60 ERROR!
    # https://groups.io/g/wwara/message/434
    ("WA6MPG", Decimal("224.98"), Decimal("222.38")): {
        "comment": "https://docs.google.com/spreadsheets/d/1g-Zu05g6w6tif-wiV_KG0GVv6gk4HttjxFIjC5MU39U/edit#gid=0&range=4:4"
    },
    # K7DKK   442.2750  447.4250 +5.15 ERROR!
    ("K7DKK", Decimal("442.275"), Decimal("447.425")): {
        "comment": "https://docs.google.com/spreadsheets/d/1g-Zu05g6w6tif-wiV_KG0GVv6gk4HttjxFIjC5MU39U/edit#gid=0&range=7:7"
    },
    # W7ACS   442.8750  447.8250 +4.95 ERROR!
    ("W7ACS", Decimal("442.875"), Decimal("447.825")): {
        "comment": "https://docs.google.com/spreadsheets/d/1g-Zu05g6w6tif-wiV_KG0GVv6gk4HttjxFIjC5MU39U/edit#gid=0&range=6:6"
    },
    # KG7OCP  443.3500  447.3500 +4.00 ERROR!
    ("KG7OCP", Decimal("443.35"), Decimal("447.35")): {
        "comment": "https://docs.google.com/spreadsheets/d/1g-Zu05g6w6tif-wiV_KG0GVv6gk4HttjxFIjC5MU39U/edit#gid=0&range=8:8"
    },
    # WA7FW   443.8500  447.8500 +4.00 ERROR!
    ("WA7FW", Decimal("443.85"), Decimal("447.85")): {
        "comment": "https://docs.google.com/spreadsheets/d/1g-Zu05g6w6tif-wiV_KG0GVv6gk4HttjxFIjC5MU39U/edit#gid=0&range=9:9"
    },
    # N7LNS   927.2125  902.2125 -25.00 ERROR!
    ("N7LNS", Decimal("927.2125"), Decimal("902.2125")): {
        "comment": "https://docs.google.com/spreadsheets/d/1g-Zu05g6w6tif-wiV_KG0GVv6gk4HttjxFIjC5MU39U/edit#gid=0&range=10:10"
    },
    # K7CH    927.2500  902.2500 -25.00 ERROR!
    ("K7CH", Decimal("927.25"), Decimal("902.25")): {
        "comment": "https://docs.google.com/spreadsheets/d/1g-Zu05g6w6tif-wiV_KG0GVv6gk4HttjxFIjC5MU39U/edit#gid=0&range=11:11"
    },
    # N7FSP  1292.3000 1267.3000 -25.00 ERROR!
    ("N7FSP", Decimal("1292.3"), Decimal("1267.3")): {
        "comment": "https://docs.google.com/spreadsheets/d/1g-Zu05g6w6tif-wiV_KG0GVv6gk4HttjxFIjC5MU39U/edit#gid=0&range=12:12"
    },
    # W7PIG   441.0500  445.0500 +4.00 ERROR!
    ("W7PIG", Decimal("441.05"), Decimal("445.05")): {
        "comment": "https://docs.google.com/spreadsheets/d/1g-Zu05g6w6tif-wiV_KG0GVv6gk4HttjxFIjC5MU39U/edit#gid=0&range=5:5"
    },
}


def match(CALL, OUTPUT, INPUT, LOCALE=None):
    offset = INPUT - OUTPUT

    for rule in RULES:
        if rule["low"] <= OUTPUT <= rule["high"]:
            if offset == rule["offset"]:
                comment = ""
                splat = (OUTPUT - rule["low"]) % ((rule["spacing"] / 1000) or 1)
                if splat:
                    comment = " ERROR? " + str(splat)
                print(FORMAT.format(CALL, OUTPUT, INPUT, offset, comment))
                return
        elif (
            (rule["low"] + rule["offset"]) <= OUTPUT <= (rule["high"] + rule["offset"])
        ):
            if offset == -rule["offset"]:
                print(FORMAT.format(CALL, OUTPUT, INPUT, offset, " REVERSED"))
                return

    key = (CALL, OUTPUT, INPUT)
    if key in EXCEPTIONS:
        print(
            FORMAT.format(CALL, OUTPUT, INPUT, offset, " " + EXCEPTIONS[key]["comment"])
        )
        return
    if key in ERRORS:
        ERRORS[key]["found"] = True
        print(
            FORMAT.format(
                CALL, OUTPUT, INPUT, offset, " ERROR! " + ERRORS[key]["comment"]
            )
        )
        return
    # TODO: Actually deal with links
    if LOCALE == "LINK":
        print(FORMAT.format(CALL, OUTPUT, INPUT, offset, " LINK"))
        return

    print(FORMAT.format(CALL, OUTPUT, INPUT, offset, " ERROR!"))


with urlopen("https://www.wwara.org/DataBaseExtract.zip") as RESPONSE:
    # ZipFile requires a file-like object that supports seek
    FILE_OBJ = BytesIO(RESPONSE.read())
    ZIPFILE = ZipFile(FILE_OBJ)

D = []
for NAME in ZIPFILE.namelist():
    if not NAME.endswith(".csv") or "Expire" in NAME:
        continue
    # if "-pending-" not in NAME:
    #    continue
    # pending = bool("-pending-" in name)
    with ZIPFILE.open(NAME, "r") as CSV:
        # Remove the DATA_SPEC_VERSION header line from the .csv
        CSV.readline()
        D.extend(DictReader(codecs.getreader("us-ascii")(CSV)))

for row in D:
    match(
        row["CALL"],
        Decimal(row["OUTPUT_FREQ"]),
        Decimal(row["INPUT_FREQ"]),
        row["LOCALE"],
    )

for key, value in ERRORS.items():
    if not value.get("found"):
        print("{:6}{:10.4f}{:10.4f} RESOLVED".format(*key))
