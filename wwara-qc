#!/usr/bin/env python3
import codecs
from csv import DictReader
from decimal import Decimal
from io import BytesIO
from urllib.request import urlopen
from zipfile import ZipFile

from channel import Channel
from wwara_plan import REPEATERS, EXCEPTIONS, ERRORS


def database():
    with urlopen("https://www.wwara.org/DataBaseExtract.zip") as response:
        # ZipFile requires a file-like object that supports seek
        zipfile = ZipFile(BytesIO(response.read()))

    for name in zipfile.namelist():
        if not name.endswith(".csv") or "Expire" in name:
            continue
        print(name)
        with zipfile.open(name, "r") as csv:
            # Remove the DATA_SPEC_VERSION header line from the .csv
            csv.readline()
            for row in DictReader(codecs.getreader("us-ascii")(csv)):
                # TODO Handle links?
                if row["LOCALE"] == "LINK":
                    continue
                yield Channel(row["CALL"], row["OUTPUT_FREQ"], row["INPUT_FREQ"])


def match(channel):
    for rule in REPEATERS:
        if channel in rule:
            return True


for channel in database():
    if match(channel):
        print(channel)
    elif match(~channel):
        print("{} REVERSED".format(channel))
    else:
        if channel in EXCEPTIONS:
            print("{} {}".format(channel, EXCEPTIONS[channel]["comment"]))
        elif channel in ERRORS:
            print("{} ERROR {}".format(channel, ERRORS[channel]["comment"]))
        else:
            print(str(channel) + " ERROR!")
